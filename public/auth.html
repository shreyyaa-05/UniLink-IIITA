<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>UniLink | Signup & Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7fc; 
            min-height: 100vh;
        }
        .card {
           background: rgba(255, 255, 255, 0.85);
           backdrop-filter: blur(10px);
           border-radius: 1.5rem;
           box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
           border: 1px solid rgba(255, 255, 255, 0.2);
           overflow: hidden;
        }
        .main-button-gradient {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed, #a855f7);
            transition: all 0.3s ease;
            background-size: 200% auto;
        }
        .main-button-gradient:hover {
            background-position: right center;
        }
        .secondary-button {
            background-color: #eef2ff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
        }
        .secondary-button:hover {
            background-color: #e0e7ff;
        }
        .input-field {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.9rem 1rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .link-purple {
            color: #6d28d9;
            font-weight: 600;
        }
        .link-purple:hover {
            text-decoration: underline;
        }
        /* Alert/Message Styles */
        .alert-error { background-color: #ef4444; }
        .alert-success { background-color: #22c55e; }
        .alert-info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container">
        </div>

    <script>
        // =======================================
        // GLOBAL STATE & ELEMENTS
        // =======================================
        const appContainer = document.getElementById('app-container');
        const appState = {
            view: 'login', // 'login', 'register', 'forgotpassword', 'resetpassword'
            token: null
        };

        // =======================================
        // HELPER FUNCTIONS
        // =======================================

        /** Shows a temporary notification message */
        const showMessage = (message, type = 'info') => {
            const alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info';
            const messageElement = document.createElement('div');
            
            // 
            // --- THIS WAS THE SYNTAX ERROR ---
            // The line below was missing backticks (`)
            //
            messageElement.className = `fixed top-4 right-4 z-50 p-3 text-white rounded-lg shadow-xl transition-all duration-300 ${alertClass}`;
            
            messageElement.textContent = message;
            document.body.appendChild(messageElement);
            setTimeout(() => {
                messageElement.remove();
            }, 3000);
        };

        /** Sets the current view and re-renders the app */
        const setView = (viewName) => {
            appState.view = viewName;
            renderApp();
        };

        /** Gets URL parameters to show the right view */
        const getViewFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view');
            const token = params.get('token');
            
            if (view === 'resetpassword' && token) {
                appState.token = token;
                return 'resetpassword';
            }
            if (view === 'register') {
                return 'register';
            }
            return 'login';
        };

        /** Generic API fetch helper */
        const apiFetch = async (endpoint, method, body, requiresAuth = false) => {
            const headers = { 'Content-Type': 'application/json' };
            const token = localStorage.getItem('token');
            if (requiresAuth && token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = {
                method: method.toUpperCase(),
                headers: headers,
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(endpoint, options);
                const data = await response.json();

                if (!response.ok) {
                    // Use the error message from the server (e.g., "Invalid credentials")
                    throw new Error(data.msg || data.message || 'An error occurred');
                }
                return data;

            } catch (err) {
                console.error('API Fetch Error:', err);
                // Re-throw the error so the calling function can handle it
                throw err; 
            }
        };

        // =======================================
        // EVENT HANDLERS
        // =======================================

        /** Handle Login Form Submission */
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Logging in...';

            try {
                // This corresponds to your authController.js `login` function
                const data = await apiFetch('/api/auth/login', 'POST', { email, password });
                
                // Success!
                localStorage.setItem('token', data.token);
                localStorage.setItem('userData', JSON.stringify(data.user));
                showMessage('Login successful! Redirecting...', 'success');
                
                setTimeout(() => {
                    // Redirect to the main page
                    window.location.href = 'main.html';
                }, 1000);

            } catch (err) {
                // This 'err.message' comes from the apiFetch helper
                showMessage(err.message, 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Login';
            }
        };

        /** Handle Register Form Submission */
        const handleRegister = async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                studentId: document.getElementById('studentId').value,
                department: document.getElementById('department').value,
                year: document.getElementById('year').value,
                password: document.getElementById('password').value,
                passwordConfirm: document.getElementById('passwordConfirm').value
            };

            if (formData.password !== formData.passwordConfirm) {
                return showMessage('Passwords do not match', 'error');
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Registering...';

            try {
                // This corresponds to your authController.js `register` function
                const data = await apiFetch('/api/auth/register', 'POST', formData);
                
                showMessage('Registration successful! Please log in.', 'success');
                setView('login'); // Switch to the login view

            } catch (err) {
                showMessage(err.message, 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Create Account';
            }
        };

        /** Handle Forgot Password Submission */
        const handleForgotPassword = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Sending...';

            try {
                const data = await apiFetch('/api/auth/forgotpassword', 'POST', { email });
                showMessage(data.msg, 'success'); // Show the "If email exists..." message
                submitButton.disabled = false;
                submitButton.textContent = 'Send Reset Link';
            } catch (err) {
                showMessage(err.message, 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Send Reset Link';
            }
        };
        
        /** Handle Reset Password Submission */
        const handleResetPassword = async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (password !== passwordConfirm) {
                return showMessage('Passwords do not match', 'error');
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Resetting...';

            try {
                const endpoint = `/api/auth/resetpassword/${appState.token}`;
                const data = await apiFetch(endpoint, 'PUT', { password });
                
                showMessage('Password reset successful! Please log in.', 'success');
                appState.token = null; // Clear the token
                setView('login'); // Send them to login

            } catch (err) {
                showMessage(err.message, 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Reset Password';
            }
        };

        // =======================================
        // UI RENDERING FUNCTIONS
        // =======================================

        /** Renders the main form layout (card, title) */
        const renderFormLayout = (title, formContent) => {
            return `
                <div class="card w-full max-w-lg p-6 sm:p-8 md:p-10">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">${title}</h1>
                        <p class="text-gray-600 mt-2">UniLink IIIT Allahabad</p>
                    </div>
                    ${formContent}
                </div>
            `;
        };

        /** Renders the HTML for the Login Form */
        const renderLogin = () => {
            const content = `
                <form id="login-form" class="space-y-5" onsubmit="handleLogin(event)">
                    <div>
                        <input type="email" id="email" class="input-field w-full" placeholder="Email (e.g., lit2021001@iiita.ac.in)" required>
                    </div>
                    <div>
                        <input type="password" id="password" class="input-field w-full" placeholder="Password" required>
                    </div>
                    <div class="text-right">
                        <a href="#" onclick="setView('forgotpassword')" class="text-sm link-purple">Forgot Password?</a>
                    </div>
                    <button type="submit" class="w-full main-button-gradient text-white py-3 rounded-xl transition duration-150 font-semibold shadow-lg">
                        Login
                    </button>
                </form>
                
                <p class="mt-6 text-sm text-center text-gray-600">New student? 
                    <a href="#" onclick="setView('register')" class="link-purple">Register New Account</a>
                </p>
                <a href="main.html" class="block w-full text-center mt-4 secondary-button py-3 rounded-xl transition duration-150 font-semibold shadow-lg">
                    Cancel and Go Back to Main
                </a>
            `;
            return renderFormLayout("Welcome Back & Log In", content);
        };
        
        /** Renders the HTML for the Registration Form */
        const renderRegister = () => {
            const content = `
                <form id="register-form" class="space-y-4" onsubmit="handleRegister(event)">
                    <input type="text" id="name" class="input-field w-full" placeholder="Full Name" required>
                    <input type="email" id="email" class="input-field w-full" placeholder="IIITA Email" required>
                    <input type="text" id="studentId" class="input-field w-full" placeholder="Student ID (e.g., lit2021001)" required>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="department" class="input-field w-full" required>
                            <option value="">Department</option>
                            <option value="IT">Information Technology</option>
                            <option value="ECE">Electronics (ECE)</option>
                        </select>
                        <select id="year" class="input-field w-full" required>
                            <option value="">Year</option>
                            <option value="1">1st Year</option>
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select>
                    </div>
                    <input type="password" id="password" class="input-field w-full" placeholder="Create Password" required>
                    <input type="password" id="passwordConfirm" class="input-field w-full" placeholder="Confirm Password" required>
                    
                    <button type="submit" class="w-full main-button-gradient text-white py-3 rounded-xl transition duration-150 font-semibold shadow-lg">
                        Create Account
                    </button>
                </form>
                
                <p class="mt-6 text-sm text-center text-gray-600">Already have an account? 
                    <a href="#" onclick="setView('login')" class="link-purple">Log In</a>
                </S>
                <a href="main.html" class="block w-full text-center mt-4 secondary-button py-3 rounded-xl transition duration-150 font-semibold shadow-lg">
                    Cancel and Go Back
                </a>
            `;
            return renderFormLayout("Create New Account", content);
        };
        
        /** Renders the HTML for the Forgot Password Form */
        const renderForgotPassword = () => {
            const content = `
                <form id="forgot-form" class="space-y-5" onsubmit="handleForgotPassword(event)">
                    <p class="text-sm text-gray-600 text-center">Enter your email and we'll send you a link to reset your password.</p>
                    <div>
                        <input type="email" id="email" class="input-field w-full" placeholder="Your IIITA Email" required>
                    </div>
                    <button type="submit" class="w-full main-button-gradient text-white py-3 rounded-xl transition duration-150 font-semibold shadow-lg">
                        Send Reset Link
                    </button>
                </form>
                
                <p class="mt-6 text-sm text-center text-gray-600">Remembered it? 
                    <a href="#" onclick="setView('login')" class="link-purple">Back to Login</a>
                </p>
            `;
            return renderFormLayout("Forgot Password", content);
        };
        
        /** Renders the HTML for the Reset Password Form */
        const renderResetPassword = () => {
            if (!appState.token) {
                return renderFormLayout("Error", "<p class='text-center text-red-600'>Invalid or missing reset token. Please try the 'Forgot Password' process again.</p>");
            }
            
            const content = `
                <form id="reset-form" class="space-y-5" onsubmit="handleResetPassword(event)">
                    <p class="text-sm text-gray-600 text-center">Enter your new password below.</p>
                    <div>
                        <input type="password" id="password" class="input-field w-full" placeholder="New Password" required>
                    </div>
                    <div>
                        <input type="password" id="passwordConfirm" class="input-field w-full" placeholder="Confirm New Password" required>
                    </div>
                    <button type="submit" class="w-full main-button-gradient text-white py-3 rounded-xl transition duration-150 font-semibold shadow-lg">
                        Reset Password
                    </button>
                </form>
            `;
            return renderFormLayout("Reset Your Password", content);
        };

        /** Main rendering function */
        const renderApp = () => {
            let html = '';
            switch (appState.view) {
                case 'login':
                    html = renderLogin();
                    break;
                case 'register':
                    html = renderRegister();
                    break;
                case 'forgotpassword':
                    html = renderForgotPassword();
                    break;
                case 'resetpassword':
                    html = renderResetPassword();
                    break;
                default:
                    html = renderLogin(); 
            }
            appContainer.innerHTML = html;
        };

        // =======================================
        // INITIALIZATION
        // =======================================
        
        const initializeApp = () => {
            appState.view = getViewFromURL();
            renderApp();
        };
        
        initializeApp();
    </script>
</body>
</html>